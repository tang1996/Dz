/*
 * 日期控件
 */
window.lCalendar=function(){
	var a=function(){
		this.gearDate,this.minY=1900,this.minM=1,this.minD=1,this.maxY=2099,this.maxM=12,this.maxD=31};
		return a.prototype={init:function(a){
			if(this.type=a.type,this.trigger=document.querySelector(a.trigger),null!=this.trigger.getAttribute("data-lcalendar")){
				var b=this.trigger.getAttribute("data-lcalendar").split(","),c=b[0].split("-");
				this.minY=~~c[0],this.minM=~~c[1],this.minD=~~c[2];
				var d=b[1].split("-");
				this.maxY=~~d[0],this.maxM=~~d[1],this.maxD=~~d[2]
			}
			this.bindEvent(this.type)},
			bindEvent:function(a){function b(a){t.gearDate=document.createElement("div"),
			t.gearDate.className="gearDate",
			t.gearDate.innerHTML='<div class="date_ctrl slideInUp"><div class="date_btn_box"><div class="date_btn lcalendar_cancel">取消</div><div class="date_btn lcalendar_finish">确定</div></div><div class="date_roll_mask"><div class="date_roll"><div><div class="gear date_yy" data-datetype="date_yy"></div><div class="date_grid"><div>年</div></div></div><div><div class="gear date_mm" data-datetype="date_mm"></div><div class="date_grid"><div>月</div></div></div><div><div class="gear date_dd" data-datetype="date_dd"></div><div class="date_grid"><div>日</div></div></div></div></div></div>',
			document.body.appendChild(t.gearDate),c();
			var b=t.gearDate.querySelector(".lcalendar_cancel");
			b.addEventListener("touchstart",p);
			var d=t.gearDate.querySelector(".lcalendar_finish");
			d.addEventListener("touchstart",q);
			var e=t.gearDate.querySelector(".date_yy"),
			f=t.gearDate.querySelector(".date_mm"),g=t.gearDate.querySelector(".date_dd");
			e.addEventListener("touchstart",k),f.addEventListener("touchstart",k),
			g.addEventListener("touchstart",k),e.addEventListener("touchmove",l),
			f.addEventListener("touchmove",l),g.addEventListener("touchmove",l),
			e.addEventListener("touchend",m),f.addEventListener("touchend",m),
			g.addEventListener("touchend",m)
			}
			
		function d(a){
			t.gearDate=document.createElement("div"),
			t.gearDate.className="gearDatetime",
			t.gearDate.innerHTML='<div class="date_ctrl slideInUp"><div class="date_btn_box"><div class="date_btn lcalendar_cancel">取消</div><div class="date_btn lcalendar_finish">确定</div></div><div class="date_roll_mask"><div class="datetime_roll"><div><div class="gear date_yy" data-datetype="date_yy"></div><div class="date_grid"><div>年</div></div></div><div><div class="gear date_mm" data-datetype="date_mm"></div><div class="date_grid"><div>月</div></div></div><div><div class="gear date_dd" data-datetype="date_dd"></div><div class="date_grid"><div>日</div></div></div><div><div class="gear time_hh" data-datetype="time_hh"></div><div class="date_grid"><div>时</div></div></div><div><div class="gear time_mm" data-datetype="time_mm"></div><div class="date_grid"><div>分</div></div></div></div></div></div>',
			document.body.appendChild(t.gearDate),e();
			var b=t.gearDate.querySelector(".lcalendar_cancel");
			b.addEventListener("touchstart",p);
			var c=t.gearDate.querySelector(".lcalendar_finish");
			c.addEventListener("touchstart",r);
			var d=t.gearDate.querySelector(".date_yy"),
			f=t.gearDate.querySelector(".date_mm"),
			g=t.gearDate.querySelector(".date_dd"),
			h=t.gearDate.querySelector(".time_hh"),
			i=t.gearDate.querySelector(".time_mm");
			d.addEventListener("touchstart",k),
			f.addEventListener("touchstart",k),
			g.addEventListener("touchstart",k),
			h.addEventListener("touchstart",k),
			i.addEventListener("touchstart",k),
			d.addEventListener("touchmove",l),
			f.addEventListener("touchmove",l),
			g.addEventListener("touchmove",l),
			h.addEventListener("touchmove",l),
			i.addEventListener("touchmove",l),
			d.addEventListener("touchend",m),
			f.addEventListener("touchend",m),
			g.addEventListener("touchend",m),
			h.addEventListener("touchend",m),
			i.addEventListener("touchend",m)
			}

		function f(a){
			t.gearDate=document.createElement("div"),
			t.gearDate.className="gearDate",
			t.gearDate.innerHTML='<div class="date_ctrl slideInUp"><div class="date_btn_box"><div class="date_btn lcalendar_cancel">取消</div><div class="date_btn lcalendar_finish">确定</div></div><div class="date_roll_mask"><div class="time_roll"><div><div class="gear time_hh" data-datetype="time_hh"></div><div class="date_grid"><div>时</div></div></div><div><div class="gear time_mm" data-datetype="time_mm"></div><div class="date_grid"><div>分</div></div></div></div></div></div>',
			document.body.appendChild(t.gearDate),
			g();var b=t.gearDate.querySelector(".lcalendar_cancel");
			b.addEventListener("touchstart",p);
			var c=t.gearDate.querySelector(".lcalendar_finish");
			c.addEventListener("touchstart",s);
			var d=t.gearDate.querySelector(".time_hh"),
			e=t.gearDate.querySelector(".time_mm");
			d.addEventListener("touchstart",k),
			e.addEventListener("touchstart",k),
			d.addEventListener("touchmove",l),
			e.addEventListener("touchmove",l),
			d.addEventListener("touchend",m),
			e.addEventListener("touchend",m)
			}
		function g(){
			var a=new Date,
			b={
				hh:a.getHours(),
				mm:a.getMinutes()
			};
			/^\d{2}:\d{2}$/.test(t.trigger.value)&&(rs=t.trigger.value.match(/(^|:)\d{2}/g),
			b.hh=parseInt(rs[0].replace(/^0?/g,"")),
			b.mm=parseInt(rs[1].replace(/:0?/g,""))),
			t.gearDate.querySelector(".time_hh").setAttribute("val",b.hh),
			t.gearDate.querySelector(".time_mm").setAttribute("val",b.mm),
			i()
			}
		
			function i(){
				var a=t.gearDate.querySelector(".time_hh");
				if(a&&a.getAttribute("val")){
					for(
						var b="",
						c=parseInt(a.getAttribute("val")),
						d=0;
						23>=d;
						d++)b+="<div class='tooth'>"+d+"</div>";
					a.innerHTML=b,
					a.style["-webkit-transform"]="translate3d(0,"+(8-2*c)+"em,0)",
					a.setAttribute("top",8-2*c+"em");
					var e=t.gearDate.querySelector(".time_mm");
					if(e&&e.getAttribute("val")){
						for(
							var b="",
							f=parseInt(e.getAttribute("val")),
							d=0;59>=d;
							d++)b+="<div class='tooth'>"+d+"</div>";
						e.innerHTML=b,
						e.style["-webkit-transform"]="translate3d(0,"+(8-2*f)+"em,0)",
						e.setAttribute("top",8-2*f+"em")
						}
					}
				}
			//滚动特效
			function k(a){a.preventDefault();
			for(var b=a.target;;){
				if(b.classList.contains("gear"))
					break;
				b=b.parentElement}clearInterval(b["int_"+b.id]),
				b["old_"+b.id]=a.targetTouches[0].screenY,
				b["o_t_"+b.id]=(new Date).getTime();
				var c=b.getAttribute("top");
				c?b["o_d_"+b.id]=parseFloat(c.replace(/em/g,"")):b["o_d_"+b.id]=0
						}
			function l(a){a.preventDefault();
			for(var b=a.target;;){
				if(b.classList.contains("gear"))
					break;
				b=b.parentElement}b["new_"+b.id]=a.targetTouches[0].screenY,
				b["n_t_"+b.id]=(new Date).getTime();
				var c=18*(b["new_"+b.id]-b["old_"+b.id])/370;
				b["pos_"+b.id]=b["o_d_"+b.id]+c,
				b.style["-webkit-transform"]="translate3d(0,"+b["pos_"+b.id]+"em,0)",
				b.setAttribute("top",
						b["pos_"+b.id]+"em")
						}
			function m(a){a.preventDefault();
			for(var b=a.target;;){
				if(b.classList.contains("gear"))
					break;
				b=b.parentElement}
			var c=(b["new_"+b.id]-b["old_"+b.id])/(b["n_t_"+b.id]-b["o_t_"+b.id]);
			Math.abs(c)<=.2?b["spd_"+b.id]=0>c?-.08:.08:Math.abs(c)<=.5?b["spd_"+b.id]=0>c?-.16:.16:b["spd_"+b.id]=c/2,b["pos_"+b.id]||(b["pos_"+b.id]=0),n(b)
					}
			function n(a){var b=0,c=!1,d=t.maxY-t.minY+1;clearInterval(a["int_"+a.id]),
			a["int_"+a.id]=setInterval(
					function(){
						var e=a["pos_"+a.id],
						f=a["spd_"+a.id]*Math.exp(-.03*b);
						if(e+=f,Math.abs(f)>.1);
						else{
							f=.1;
							var g=2*Math.round(e/2);
							Math.abs(e-g)<.02?c=!0:e>g?e-=f:e+=f
						}
						switch(e>8&&(e=8,c=!0),a.dataset.datetype){case"date_yy":var h=8-2*(d-1);
						if(h>e&&(e=h,c=!0),c){
							var i=Math.abs(e-8)/2;
							o(a,i),
							clearInterval(a["int_"+a.id])
							}
						break;
						
						case"time_hh":if(-38>e&&(e=-38,c=!0),c){
							var i=Math.abs(e-8)/2;
							o(a,i),
							clearInterval(a["int_"+a.id])
							}
						break;
						case"time_mm":if(-110>e&&(e=-110,c=!0),c){
							var i=Math.abs(e-8)/2;
							o(a,i),
							clearInterval(a["int_"+a.id])
							}
						}
						a["pos_"+a.id]=e,
						a.style["-webkit-transform"]="translate3d(0,"+e+"em,0)",
						a.setAttribute("top",e+"em"),
						b++
						},
						30)
						}
			function o(a,b){b=Math.round(b),
				a.setAttribute("val",b),
				/date/.test(a.dataset.datetype)?h():i()
						}
			function p(a){a.preventDefault();
			var b=new CustomEvent("input");
			t.trigger.dispatchEvent(b),
			document.body.removeChild(t.gearDate)
			}
			
			function s(a){
				var b=parseInt(Math.round(t.gearDate.querySelector(".time_hh").getAttribute("val")));
				b=b>9?b:"0"+b;
				var c=parseInt(Math.round(t.gearDate.querySelector(".time_mm").getAttribute("val")));
				c=c>9?c:"0"+c,
						t.trigger.value=(b.length<2?"0":"")+b+(c.length<2?":0":":")+c,
						p(a)
						}
			var t=this;
			t.trigger.addEventListener("click",{date:b,datetime:d,time:f}[a])}},
			a}();
